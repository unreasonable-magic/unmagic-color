#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "unmagic_color"
require "irb"
require "irb/helper_method"

# Helper methods for color parsing
class RGBHelper < IRB::HelperMethod::Base
  description "Build an RGB color"

  def execute(*args, **kwargs)
    Unmagic::Color::RGB.build(*args, **kwargs)
  end
end

class HSLHelper < IRB::HelperMethod::Base
  description "Build an HSL color"

  def execute(*args, **kwargs)
    Unmagic::Color::HSL.build(*args, **kwargs)
  end
end

class OKLCHHelper < IRB::HelperMethod::Base
  description "Build an OKLCH color"

  def execute(*args, **kwargs)
    Unmagic::Color::OKLCH.build(*args, **kwargs)
  end
end

class ParseHelper < IRB::HelperMethod::Base
  description "Parse any color format (hex, rgb, hsl, oklch, named)"

  def execute(*args, **kwargs)
    Unmagic::Color[*args, **kwargs]
  end
end

class GradientHelper < IRB::HelperMethod::Base
  description "Create a gradient (auto-detects color space)"

  def execute(type, *args, **kwargs)
    case type
    when :linear
      Unmagic::Color::Gradient.linear(*args, **kwargs)
    else
      raise ArgumentError, "Unknown gradient type: #{type}"
    end
  end
end

class PercentageHelper < IRB::HelperMethod::Base
  description "Build a Percentage"

  def execute(*args, **kwargs)
    Unmagic::Util::Percentage.build(*args, **kwargs)
  end
end

IRB::HelperMethod.register(:rgb, RGBHelper)
IRB::HelperMethod.register(:hsl, HSLHelper)
IRB::HelperMethod.register(:oklch, OKLCHHelper)
IRB::HelperMethod.register(:parse, ParseHelper)
IRB::HelperMethod.register(:gradient, GradientHelper)
IRB::HelperMethod.register(:percentage, PercentageHelper)

# Print welcome banner with syntax highlighting
def colorize(text, color, mode: :truecolor)
  "\e[#{color.to_ansi(mode: mode)}m#{text}\e[0m"
end

def highlight(code)
  green = Unmagic::Color["green"]
  magenta = Unmagic::Color["#ff00ff"]
  yellow = Unmagic::Color["yellow"]

  code
    .gsub(/(".*?")/) { colorize(Regexp.last_match(1), green, mode: :palette16) } # Strings in green
    .gsub(/\b(\d+\.?\d*)\b/) { colorize(Regexp.last_match(1), magenta, mode: :palette16) } # Numbers in magenta
    .gsub(/(\:[a-z_]+|[a-z_]+\:)/) { colorize(Regexp.last_match(1), yellow, mode: :palette16) } # Numbers in magenta
end

def comment(text)
  gray = Unmagic::Color["dimgray"]
  colorize(text, gray)
end

# Colorize banner with an angled gradient
def colorize_banner
  banner_lines = [
    "                                                              ▄▄",
    "                                  ▀▀                          ██",
    " ██ ██ ████▄ ███▄███▄  ▀▀█▄ ▄████ ██  ▄████       ▄████ ▄███▄ ██ ▄███▄ ████▄",
    " ██ ██ ██ ██ ██ ██ ██ ▄█▀██ ██ ██ ██  ██    ▀▀▀▀▀ ██    ██ ██ ██ ██ ██ ██ ▀▀",
    " ▀██▀█ ██ ██ ██ ██ ██ ▀█▄██ ▀████ ██▄ ▀████       ▀████ ▀███▀ ██ ▀███▀ ██",
    "                               ██",
    "                             ▀▀▀",
  ]

  # Create a gradient (45 degree angle, vibrant colors)
  gradient = Unmagic::Color::Gradient.linear(
    ["#ff00ff", "#00ffff", "#00ff00", "#ffff00", "#ff0000"],
    direction: "left to right", # Bottom-left to top-right diagonal
  )

  # Calculate dimensions
  height = banner_lines.length
  width = banner_lines.map(&:length).max

  # Rasterize the gradient to match banner dimensions
  bitmap = gradient.rasterize(width: width, height: height)

  # Apply gradient to each character
  banner_lines.each_with_index.map do |line, y|
    line.chars.each_with_index.map do |char, x|
      if char.strip.empty?
        char # Keep whitespace as-is
      else
        color = bitmap.pixels[y][x]
        "\e[#{color.to_ansi}m#{char}\e[0m"
      end
    end.join
  end.join("\n")
end

puts colorize_banner
puts "https://github.com/unmagic/unmagic-color"
puts ""
puts comment("# Parse colors")
puts highlight('parse("#ff5733")')
puts highlight("rgb(255, 87, 51)")
puts highlight("hsl(9, 100, 60)")
puts highlight("oklch(0.65, 0.22, 30)")
puts highlight('parse("rebeccapurple")')
puts ""
puts comment("# Manipulate colors")
puts highlight('color = parse("#ff5733")')
puts highlight("color.lighten(0.1)")
puts highlight("color.darken(0.1)")
puts highlight("color.saturate(0.1)")
puts highlight("color.desaturate(0.1)")
puts highlight("color.rotate(30)")
puts ""
puts comment("# Convert between formats")
puts highlight("color.to_rgb")
puts highlight("color.to_hsl")
puts highlight("color.to_oklch")
puts highlight("color.to_hex")
puts highlight("color.to_css_oklch")
puts ""
puts comment("# Create gradients")
puts highlight('gradient(:linear, ["#FF0000", "#0000FF"]).rasterize(width: 10).pixels[0].map(&:to_hex)')
puts ""
puts comment("# Helpers")
puts highlight("rgb(255, 87, 51)")
puts highlight("hsl(9, 100, 60)")
puts highlight("oklch(0.65, 0.22, 30)")
puts highlight('parse("#ff5733")')
puts highlight('gradient(:linear, ["#FF0000", "#0000FF"])')
puts highlight("percentage(50)")
puts ""

# Configure IRB with custom prompt
ARGV.clear

IRB.setup(nil)
IRB.conf[:PROMPT][:UNMAGIC_COLOR] = {
  PROMPT_I: "unmagic-color> ",
  PROMPT_S: "unmagic-color%l ",
  PROMPT_C: "unmagic-color* ",
  RETURN: "=> %s\n",
}
IRB.conf[:PROMPT_MODE] = :UNMAGIC_COLOR

require "irb/workspace"
workspace = IRB::WorkSpace.new(binding)
IRB::Irb.new(workspace).run(IRB.conf)
