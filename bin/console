#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "unmagic_color"
require "unmagic/color/console/banner"
require "unmagic/color/console/help"
require "unmagic/color/console/card"
require "unmagic/color/console/highlighter"
require "irb"
require "irb/helper_method"

# Helper methods for color parsing
class RGBHelper < IRB::HelperMethod::Base
  description "Build an RGB color"

  def execute(*args, **kwargs)
    Unmagic::Color::RGB.build(*args, **kwargs)
  end
end

class HSLHelper < IRB::HelperMethod::Base
  description "Build an HSL color"

  def execute(*args, **kwargs)
    Unmagic::Color::HSL.build(*args, **kwargs)
  end
end

class OKLCHHelper < IRB::HelperMethod::Base
  description "Build an OKLCH color"

  def execute(*args, **kwargs)
    Unmagic::Color::OKLCH.build(*args, **kwargs)
  end
end

class ParseHelper < IRB::HelperMethod::Base
  description "Parse any color format (hex, rgb, hsl, oklch, named)"

  def execute(*args, **kwargs)
    Unmagic::Color[*args, **kwargs]
  end
end

class GradientHelper < IRB::HelperMethod::Base
  description "Create a gradient (auto-detects color space)"

  def execute(type, *args, **kwargs)
    case type
    when :linear
      Unmagic::Color::Gradient.linear(*args, **kwargs)
    else
      raise ArgumentError, "Unknown gradient type: #{type}"
    end
  end
end

class PercentageHelper < IRB::HelperMethod::Base
  description "Build a Percentage"

  def execute(*args, **kwargs)
    Unmagic::Util::Percentage.build(*args, **kwargs)
  end
end

class ShowHelper < IRB::HelperMethod::Base
  description "Show a color profile card with color spaces, harmonies, and variations"

  def execute(input)
    puts Unmagic::Color::Console::Card.new(input).render
    nil
  end
end

IRB::HelperMethod.register(:rgb, RGBHelper)
IRB::HelperMethod.register(:hsl, HSLHelper)
IRB::HelperMethod.register(:oklch, OKLCHHelper)
IRB::HelperMethod.register(:parse, ParseHelper)
IRB::HelperMethod.register(:gradient, GradientHelper)
IRB::HelperMethod.register(:percentage, PercentageHelper)
IRB::HelperMethod.register(:show, ShowHelper)

# Syntax highlighter for console output
$highlighter = Unmagic::Color::Console::Highlighter.new

def highlight(code)
  $highlighter.highlight(code)
end

def comment(text)
  $highlighter.comment(text)
end

puts Unmagic::Color::Console::Banner.new.render
puts Unmagic::Color::Console::Help.new.render
puts ""

# Configure IRB with custom prompt
ARGV.clear

IRB.setup(nil)
IRB.conf[:PROMPT][:UNMAGIC_COLOR] = {
  PROMPT_I: "unmagic-color> ",
  PROMPT_S: "unmagic-color%l ",
  PROMPT_C: "unmagic-color* ",
  RETURN: "=> %s\n",
}
IRB.conf[:PROMPT_MODE] = :UNMAGIC_COLOR

require "irb/workspace"
workspace = IRB::WorkSpace.new(binding)
IRB::Irb.new(workspace).run(IRB.conf)
